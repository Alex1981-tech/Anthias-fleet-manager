<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config_name }} — CCTV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; }
        #video, #snapshot { width: 100%; height: 100%; object-fit: contain; display: none; }
        #snapshot.active { display: block; }
        #video.active { display: block; }
        #status {
            position: absolute;
            bottom: 10px; left: 10px;
            color: rgba(255,255,255,0.6);
            font-family: monospace;
            font-size: 12px;
            z-index: 10;
        }
        #status.hidden { display: none; }

        /* Grid mode styles */
        #grid-container {
            display: none;
            width: 100%;
            height: 100%;
            gap: 2px;
            background: #000;
        }
        #grid-container.active {
            display: grid;
        }
        .grid-cell {
            position: relative;
            overflow: hidden;
            background: #111;
        }
        .grid-cell video,
        .grid-cell img,
        .grid-cell iframe {
            display: block;
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: fill;
            border: none;
        }
        .grid-cell-label {
            position: absolute;
            bottom: 4px; left: 6px;
            color: rgba(255,255,255,0.7);
            font-family: monospace;
            font-size: 11px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline></video>
    <img id="snapshot" alt="">
    <div id="grid-container"></div>
    <div id="status">...</div>

    <script>
        var CONFIG_ID = '{{ config_id|escapejs }}';
        var DISPLAY_MODE = '{{ display_mode|escapejs }}';
        var ROTATION_INTERVAL = {{ rotation_interval }};
        var CAMERA_COUNT = {{ camera_count }};
        var GRID_MODE = {{ grid_mode|yesno:"true,false" }};
        var GRID_COLS = {{ grid_cols }};
        var GRID_ROWS = {{ grid_rows }};
        var CAMERAS = {{ cameras_json|safe }};

        var video = document.getElementById('video');
        var snapshot = document.getElementById('snapshot');
        var gridContainer = document.getElementById('grid-container');
        var statusDiv = document.getElementById('status');
        var hlsPlaying = false;
        var snapshotMode = false;
        var snapshotTimer = null;
        var hideTimer = null;

        function log(msg) { statusDiv.textContent = msg; }
        function hideStatus() { statusDiv.classList.add('hidden'); }

        // Keepalive: ping FM every 60s
        (function keepalive() {
            var url = '/api/cctv/' + CONFIG_ID + '/request-start/';
            setInterval(function() {
                fetch(url, { method: 'POST' }).catch(function() {});
            }, 60000);
        })();

        if (GRID_MODE) {
            loadHlsLib(startGridMode);
        } else {
            var hlsSrc = DISPLAY_MODE === 'mosaic'
                ? '/media/cctv/' + CONFIG_ID + '/stream.m3u8'
                : '/media/cctv/' + CONFIG_ID + '/cam_0/stream.m3u8';
            var snapshotSrc = '/media/cctv/' + CONFIG_ID + '/snapshot.jpg';
            tryHLS();
        }

        var hlsLib = null; // will be set after loading
        function loadHlsLib(cb) {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/hls.js@1';
            script.onload = function() { hlsLib = typeof Hls !== 'undefined' && Hls.isSupported() ? Hls : null; cb(); };
            script.onerror = function() { hlsLib = null; cb(); };
            document.head.appendChild(script);
        }

        function startGridMode() {
            log('Grid mode');
            gridContainer.style.gridTemplateColumns = 'repeat(' + GRID_COLS + ', 1fr)';
            gridContainer.style.gridTemplateRows = 'repeat(' + GRID_ROWS + ', 1fr)';
            gridContainer.classList.add('active');

            CAMERAS.forEach(function(cam) {
                var cell = document.createElement('div');
                cell.className = 'grid-cell';

                if (cam.source_type === 'web') {
                    // Web source: iframe fills cell, no sandbox (Pi Qt WebEngine compat)
                    var iframe = document.createElement('iframe');
                    iframe.src = cam.url;
                    iframe.setAttribute('loading', 'lazy');
                    iframe.setAttribute('allow', 'autoplay; encrypted-media');
                    cell.appendChild(iframe);

                    setInterval(function() {
                        try { iframe.contentWindow.location.reload(); } catch(e) {
                            iframe.src = cam.url + (cam.url.indexOf('?') >= 0 ? '&' : '?') + '_t=' + Date.now();
                        }
                    }, 60000);
                } else {
                    // RTSP source: try HLS video, fallback to snapshot
                    var camHlsSrc = '/media/cctv/' + CONFIG_ID + '/cam_' + cam.index + '/stream.m3u8';
                    var camSnapshotSrc = '/media/cctv/' + CONFIG_ID + '/cam_' + cam.index + '.jpg';

                    if (hlsLib) {
                        var vid = document.createElement('video');
                        vid.autoplay = true;
                        vid.muted = true;
                        vid.playsInline = true;
                        cell.appendChild(vid);

                        (function(v, hlsSrc, snapSrc, c) {
                            var netRetries = 0;
                            var hls = new Hls({
                                liveDurationInfinity: true,
                                liveBackBufferLength: 0,
                                maxBufferLength: 5,
                                maxMaxBufferLength: 10,
                                enableWorker: false,
                                lowLatencyMode: true,
                                manifestLoadingMaxRetry: 6,
                                manifestLoadingRetryDelay: 2000,
                                levelLoadingMaxRetry: 6,
                                levelLoadingRetryDelay: 2000,
                                fragLoadingMaxRetry: 6,
                            });
                            hls.loadSource(hlsSrc);
                            hls.attachMedia(v);
                            hls.on(Hls.Events.MANIFEST_PARSED, function() { v.play().catch(function(){}); });
                            hls.on(Hls.Events.ERROR, function(ev, data) {
                                if (data.fatal) {
                                    if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                                        hls.recoverMediaError();
                                    } else if (data.type === Hls.ErrorTypes.NETWORK_ERROR && netRetries < 5) {
                                        netRetries++;
                                        setTimeout(function() { hls.startLoad(); }, 3000);
                                    } else {
                                        // HLS failed — switch to snapshot fallback
                                        hls.destroy();
                                        v.remove();
                                        gridCellSnapshot(c, snapSrc);
                                    }
                                }
                            });
                        })(vid, camHlsSrc, camSnapshotSrc, cell);
                    } else {
                        // No HLS support — snapshot mode
                        gridCellSnapshot(cell, camSnapshotSrc);
                    }
                }

                // Label
                var label = document.createElement('div');
                label.className = 'grid-cell-label';
                label.textContent = cam.name;
                cell.appendChild(label);

                gridContainer.appendChild(cell);
            });

            hideTimer = setTimeout(hideStatus, 3000);
        }

        function gridCellSnapshot(cell, src) {
            var img = document.createElement('img');
            img.alt = '';
            function refresh() {
                var tmp = new Image();
                tmp.onload = function() { img.src = tmp.src; };
                tmp.src = src + '?t=' + Date.now();
            }
            refresh();
            setInterval(refresh, 2000);
            // Insert before label
            var label = cell.querySelector('.grid-cell-label');
            if (label) cell.insertBefore(img, label);
            else cell.appendChild(img);
        }

        function tryHLS() {
            log('Trying HLS...');

            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/hls.js@1';
            script.onload = function() {
                if (Hls.isSupported()) {
                    log('hls.js: MSE OK');
                    initHLS(hlsSrc);
                } else {
                    log('MSE not supported');
                    startSnapshotMode();
                }
            };
            script.onerror = function() {
                log('CDN unavailable');
                startSnapshotMode();
            };
            document.head.appendChild(script);

            setTimeout(function() {
                if (!hlsPlaying && !snapshotMode) {
                    log('HLS timeout');
                    startSnapshotMode();
                }
            }, 8000);
        }

        function initHLS(src) {
            var netRetries = 0;
            var hls = new Hls({
                liveDurationInfinity: true,
                liveBackBufferLength: 0,
                maxBufferLength: 5,
                maxMaxBufferLength: 10,
                enableWorker: true,
                lowLatencyMode: true,
                manifestLoadingMaxRetry: 6,
                manifestLoadingRetryDelay: 2000,
                levelLoadingMaxRetry: 6,
                levelLoadingRetryDelay: 2000,
                fragLoadingMaxRetry: 6,
            });

            hls.loadSource(src);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play().catch(function() {});
            });

            video.addEventListener('playing', function() {
                if (!hlsPlaying) {
                    hlsPlaying = true;
                    video.classList.add('active');
                    snapshot.classList.remove('active');
                    log('HLS OK');
                    hideTimer = setTimeout(hideStatus, 5000);
                }
            });

            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                        hls.recoverMediaError();
                    } else if (data.type === Hls.ErrorTypes.NETWORK_ERROR && netRetries < 5) {
                        netRetries++;
                        log('HLS retry ' + netRetries + '/5...');
                        setTimeout(function() { hls.startLoad(); }, 3000);
                    } else {
                        if (!snapshotMode) {
                            log('HLS error: ' + data.details);
                            startSnapshotMode();
                        }
                    }
                }
            });

            if (DISPLAY_MODE === 'rotation' && CAMERA_COUNT > 1) {
                var currentCam = 0;
                setInterval(function() {
                    currentCam = (currentCam + 1) % CAMERA_COUNT;
                    hls.loadSource('/media/cctv/' + CONFIG_ID + '/cam_' + currentCam + '/stream.m3u8');
                }, ROTATION_INTERVAL * 1000);
            }
        }

        function startSnapshotMode() {
            if (snapshotMode) return;
            snapshotMode = true;
            video.classList.remove('active');
            snapshot.classList.add('active');
            log('Snapshot mode');

            function loadSnapshot() {
                var img = new Image();
                img.onload = function() {
                    snapshot.src = img.src;
                    if (!hideTimer) {
                        hideTimer = setTimeout(hideStatus, 5000);
                    }
                };
                img.src = snapshotSrc + '?t=' + Date.now();
            }

            loadSnapshot();
            snapshotTimer = setInterval(loadSnapshot, 500);
        }
    </script>
</body>
</html>
